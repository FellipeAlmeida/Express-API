name: Build and Deploy application

on:
  push: 
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy application 
    runs-on: ubuntu-latest
    steps:

      # baixa o cÃ³digo 
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      # no docker compose usa o .env, entÃ£o Ã© necessÃ¡rio recriÃ¡-lo na mÃ¡quina virtual do github
      - name: Criar .env 
        run:  |
          echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
          echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
          echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env
          echo "POSTGRES_HOST=${{ secrets.POSTGRES_HOSTPOSTGRES_HOST }}" >> .env
          echo "PORT=${{ secrets.PORT }}" >> .env

      - name: Builda imagem
        run: docker compose up -d --build
      # trigger 
      - name: Disparar deploy no render
        run: curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}

  notificar-telegram:
    name: Notifica atualizaÃ§Ãµes no telegram
    runs-on: ubuntu-latest
    continue-on-error: true
    if: always() 
    needs: [build-and-deploy]

    steps:

    - name: Notificar sucesso
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.BOT_ID }}
        token: ${{ secrets.BOT_TOKEN }}
        format: markdown
        message: |
          âœ… *Deploy realizado com sucesso!*
          ğŸ“¦ AplicaÃ§Ã£o: *Express-API - Render*
          ğŸš€ Ambiente: ${{ github.ref == 'refs/heads/main' && 'Homolog' || 'Desenvolvimento' }}
          ğŸ‘¤ Autor: ${{ github.actor }}
          ğŸ·ï¸ VersÃ£o: *${{ github.run_number }}*
          ğŸ”„ Commit: [Clique aqui](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          ğŸ“¦ Deploy: [Clique aqui](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

    - name: Notificar erro
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.BOT_ID }}
        token: ${{ secrets.BOT_TOKEN }}
        format: markdown
        message: |
            âŒ *Deploy falhou!*
            ğŸ“¦ AplicaÃ§Ã£o: *Express-API - Render*
            ğŸš€ Ambiente: ${{ github.ref == 'refs/heads/main' && 'Homolog' || 'Desenvolvimento' }}
            ğŸ‘¤ Autor: ${{ github.actor }}
            ğŸ·ï¸ VersÃ£o: ```${{ github.run_number }}```
            ğŸ”„ Commit: [Clique aqui](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            ğŸ“¦ Deploy: [Clique aqui](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})